# 视频拖拽上传功能

## 功能概述

现在 SkillFlow 支持三种方式上传视频进行技能生成：

### 1. 📎 粘贴视频链接（原有功能）
- 在输入框中直接粘贴 Bilibili、YouTube 等视频链接
- 点击链接按钮打开 URL 输入对话框

### 2. 📁 选择本地文件（新功能）
- 点击输入框左侧的 **视频上传按钮**（video.badge.plus 图标）
- 在文件选择器中选择本地视频文件
- 支持格式：MP4, MOV, AVI, MKV, FLV, WMV, M4V

### 3. 🖱️ 拖拽上传（新功能）
- 直接将视频文件拖拽到聊天窗口
- 拖拽时会显示蓝色虚线框和提示信息
- 松开鼠标即可开始上传处理

## 技术实现

### 前端改动

#### 1. ChatView.swift
- 添加了 `onDrop` 修饰符支持拖拽
- 添加了 `isDraggingOver` 状态显示拖拽提示
- 实现了 `handleDrop` 方法处理文件拖拽
- 验证文件扩展名确保是视频格式

#### 2. InputBar.swift
- 添加了文件上传按钮
- 使用 `fileImporter` 打开系统文件选择器
- 支持的文件类型：`.movie`, `.video`, `.mpeg4Movie`, `.quickTimeMovie`
- 添加了 `onFileSelect` 回调传递选中的文件 URL

#### 3. ChatViewModel.swift
- 新增 `processLocalVideo(url:)` 方法
- 处理本地视频文件的完整流程：
  1. 访问安全作用域资源（Security-Scoped Resource）
  2. 跳过下载步骤（文件已在本地）
  3. 使用 ffmpeg 提取音频和处理视频
  4. 上传到 S3
  5. 创建任务并调用后端 API
  6. 轮询获取结果
  7. 保存生成的技能

### 处理流程

```
本地视频文件
    ↓
访问文件权限
    ↓
ffmpeg 分离音视频
    ↓
上传到 S3
    ↓
创建后端任务
    ↓
音频转录
    ↓
视频分析
    ↓
生成技能步骤
    ↓
保存到本地数据库
```

## 用户体验

### 拖拽提示
当用户拖拽文件到窗口时，会显示：
- 📹 大图标
- "松开以上传视频" 提示文字
- "支持 MP4, MOV, AVI 等格式" 说明
- 蓝色虚线边框

### 进度显示
上传本地视频时，会显示详细的处理阶段：
1. ✅ 本地文件已就绪（跳过下载）
2. 🎵 正在使用 ffmpeg 分离音视频
3. ☁️ 正在上传文件（显示百分比）
4. 📝 正在创建任务
5. 🎤 音频转录中
6. 🎬 视频分析中
7. 📋 生成步骤中
8. ✅ 完成

### 错误处理
- 不支持的文件格式会显示错误提示
- 文件访问权限问题会给出明确提示
- 处理失败会显示详细错误信息

## 安全性

- 使用 macOS 的 Security-Scoped Resource 机制
- 正确调用 `startAccessingSecurityScopedResource()` 和 `stopAccessingSecurityScopedResource()`
- 确保在处理完成后释放文件访问权限

## 兼容性

- ✅ 与原有的 URL 链接上传功能完全兼容
- ✅ 不影响现有的聊天和技能执行功能
- ✅ 支持 macOS 15.7+

## 未来改进

- [ ] 支持批量上传多个视频
- [ ] 添加视频预览功能
- [ ] 支持更多视频格式
- [ ] 添加视频压缩选项
- [ ] 显示上传速度和剩余时间
